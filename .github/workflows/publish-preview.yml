name: Publish preview

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch to publish from'
        required: true
        type: string
      version:
        description: 'Version to publish'
        required: true
        type: string
    secrets:
      NPM_TOKEN:
        required: true
  push:
    branches:
      - 'preview/**'

env:
  PACKAGE_NAME: wa-kitchen
  PACKAGE_TAG: preview

permissions:
  id-token: write
  contents: write
  checks: write
  pull-requests: write

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Alert PR - Publishing started
        uses: actions/github-script@v8
        with:
          script: |
            const script = require('./.github/scripts/pr-preview-guard.js');
            await script({ github, context, core });
        env:
          PUBLISH_STATUS: 'started'
          PACKAGE_NAME: ${{ env.PACKAGE_NAME }}
          PREVIEW_VERSION: ${{ inputs.version }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Set up environment
        run: |
          git config --global user.name "GitHub Actions [Bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            BUILD="0"
          else
            CURRENT_BUILD=$(cat out/.build 2>/dev/null || echo "0")
            VERSION=$(cat out/.version)
            BUILD=$((CURRENT_BUILD + 1))
          fi

          echo "$BUILD" > out/.build
          echo "BUILD=$BUILD" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Publishing version: $VERSION-$PACKAGE_TAG.$BUILD"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate preview packages
        id: generate_preview
        continue-on-error: true
        run: bash generate.sh
        working-directory: tools/packager
        env:
          OUT_DIR: ${{ github.workspace }}/out
          VERSION: "${{ env.VERSION }}-$PACKAGE_TAG.${{ env.BUILD }}"

      - name: Publish preview packages
        id: publish_preview
        if: steps.generate_preview.outcome == 'success'
        continue-on-error: true
        run: bash publish.sh
        working-directory: tools/packager
        env:
          DIST_DIR: ${{ github.workspace }}/out/dist
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit build increment
        if: inputs.version == '' && steps.publish_preview.outcome == 'success'
        run: |
          git add out/.build
          git commit -m "chore: increment preview build to ${{ env.BUILD }}"
          git push

      - name: Alert PR - Publishing completed
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const script = require('./.github/scripts/pr-preview-guard.js');
            const gen = "${{ steps.generate_preview.outcome }}";
            const pub = "${{ steps.publish_preview.outcome }}";
            const failed = gen !== "success" || pub !== "success";

            process.env.PUBLISH_STATUS = failed ? 'failure' : 'success';
            await script({ github, context, core });
        env:
          PREVIEW_VERSION: ${{ env.VERSION }}-${{ env.PACKAGE_TAG }}.${{ env.BUILD }}
          PACKAGE_NAME: ${{ env.PACKAGE_NAME }}

      - name: Report preview publish status
        uses: actions/github-script@v8
        with:
          script: |
            const gen = "${{ steps.generate_preview.outcome }}";
            const pub = "${{ steps.publish_preview.outcome }}";
            const failed = gen !== "success" || pub !== "success";

            const packageName = "${{ env.PACKAGE_NAME }}";
            const previewVersion = "${{ env.VERSION }}-${{ env.PACKAGE_TAG }}.${{ env.BUILD }}";
            const npmUrl = `https://www.npmjs.com/package/${packageName}/v/${previewVersion}`;

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "publish-status",
              head_sha: context.sha,
              status: "completed",
              conclusion: failed ? "failure" : "success",
              output: {
                title: failed
                  ? `‚ùå Failed to publish v${previewVersion}`
                  : `‚úÖ v${previewVersion} published successfully`,
                summary: failed
                  ? "Preview publication failed. Check the workflow logs for details."
                  : `## üéâ Preview version available on NPM\n\n` +
                    `**Version:** \`${previewVersion}\`\n\n` +
                    `**NPM Package:** [${packageName}@${previewVersion}](${npmUrl})\n\n`
              }
            });
