name: Publish preview on PR Create

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PACKAGE_NAME: wa-kitchen

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          cache: npm
          node-version: 24
          cache-dependency-path: tools/scraper/package-lock.json

      - name: Set up environment
        run: |
          mkdir -p out/packages
          echo 0 > out/.build

          [ -r out/.build ] && BUILD=$(cat out/.build)
          [ -r out/.version ] && VERSION=$(cat out/.version)

          echo "BUILD=${BUILD}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          echo "Current WhatsApp Web version: ${VERSION:-none}"

      - name: Install packager dependencies
        if: env.package_update_needed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate preview package
        if: env.package_update_needed == 'true'
        run: bash generate.sh
        working-directory: tools/packager
        env:
          OUT_DIR: ${{ github.workspace }}/out
          PREVIEW_VERSION: "${{ env.NEWEST_VERSION }}-preview.${{ env.BUILD }}"

      - name: Publish preview to NPM
        if: env.package_update_needed == 'true'
        run: bash publish.sh
        working-directory: tools/packager
        env:
          DIST_DIR: ${{ github.workspace }}/out/dist
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Report preview publish status
        if: env.package_update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.publish_preview.outcome }}';
            const conclusion = status === 'success' ? 'success' : 'failure';
            const previewVersion = '${{ env.NEWEST_VERSION }}-preview.${{ env.BUILD }}';

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'preview-published',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: conclusion === 'success'
                  ? '✅ Preview version published successfully'
                  : '❌ Failed to publish preview version',
                summary: conclusion === 'success'
                  ? `Preview version ${previewVersion} is now available on NPM with tag 'preview'`
                  : 'Preview publication failed. Check workflow logs for details. PR created for documentation purposes.'
              }
            });
